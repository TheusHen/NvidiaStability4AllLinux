name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  python-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Python linting
        run: |
          pip install flake8
          flake8 src/ tests/ --max-line-length=120 --ignore=E501,W503

      - name: Run Python tests
        run: |
          pytest tests/test_nvidia_stability.py -v --tb=short

      - name: Run Python tests with coverage
        run: |
          pytest tests/test_nvidia_stability.py -v --cov=src --cov-report=xml --cov-report=term

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  bash-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Make scripts executable
        run: |
          chmod +x bin/nvidia-stability.sh
          chmod +x tests/test_bash.sh

      - name: Run Bash linting
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          shellcheck bin/nvidia-stability.sh || true

      - name: Run Bash tests
        run: |
          bash tests/test_bash.sh

  multi-distro-syntax-check:
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - container: ubuntu:22.04
            name: Ubuntu 22.04
          - container: debian:12
            name: Debian 12
          - container: fedora:39
            name: Fedora 39
          - container: archlinux:latest
            name: Arch Linux
          - container: opensuse/leap:15.5
            name: openSUSE Leap

    name: Syntax Check - ${{ matrix.name }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Python (Debian/Ubuntu)
        if: contains(matrix.container, 'ubuntu') || contains(matrix.container, 'debian')
        run: |
          apt-get update
          apt-get install -y python3 python3-pip bash

      - name: Install Python (Fedora)
        if: contains(matrix.container, 'fedora')
        run: |
          dnf install -y python3 python3-pip bash

      - name: Install Python (Arch)
        if: contains(matrix.container, 'archlinux')
        run: |
          pacman -Sy --noconfirm python python-pip bash

      - name: Install Python (openSUSE)
        if: contains(matrix.container, 'opensuse')
        run: |
          zypper install -y python3 python3-pip bash

      - name: Verify Python syntax
        run: |
          python3 -m py_compile src/nvidia_stability.py

      - name: Verify Bash syntax
        run: |
          bash -n bin/nvidia-stability.sh

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          pip install bandit safety

      - name: Run Bandit security scan
        run: |
          bandit -r src/ -ll || true

      - name: Check dependencies for vulnerabilities
        run: |
          safety check -r requirements.txt || true
